<?php
require_once '../util/pdoconn.php';
require_once '../vo/userVO.php';

// 5.3.7 버전 이하 password_hash
require_once "../util/password.php";

class userDAO {
    
     private $connect;
     
     // DB연결
     public function userDAO(){
         
         $pdo = new PDOconn();
         $this->connect = $pdo->get_connetion();
     }
     
     
     // 회원 목록
     public function userList() {
         
         try {
             
            $sql = $this->connect->prepare("SELECT nMovieSeq, sMovieTitle, sMovieStory
            , sMovieImage, dtOpeningDate, sMovieDirector
            FROM tMovieList
            ORDER BY dtOpeningDate DESC");
            
            $sql->execute();
            $voArray = array();           
            
            while($row = $sql->fetch()){
                // VO클래스에 담아서 보내기 위해 생성
                $vo = new MovieVO();
                
                $vo->setMovieSeq($row['nMovieSeq']);
                $vo->setMovieTitle($row['sMovieTitle']);
                $vo->setMovieDirector($row['sMovieDirector']);
                $vo->setMovieStory($row['sMovieStory']);
                $vo->setMovieImage($row['sMovieImage']);
                $vo->setOpeningDate($row['dtOpeningDate']);
                
                array_push($voArray, $vo);
            }
            
            return $voArray;
         }
         
         catch(PDOException $ex){
             throw $ex->getMessage();
         }
     }
     // 로그인
     public function signIn($userEmail, $userPassword){
         try
         {
             $sql = $this->connect->prepare("SELECT sUserEmail, sPassword, sNickName, nUserAdmin FROM tUserList
            WHERE sUserEmail = :userEmail");
             
             $sql->bindValue(':userEmail', $userEmail);
             $sql->execute();
             
             while($row = $sql->fetch()){
                 $hash = $row['sPassword'];
                 $user_nickName = $row['sNickName'];
                 $user_admin = $row['nUserAdmin'];
             }
             
             // 비밀번호 일치여부 확인
             if (password_verify($userPassword, $hash)) {
                 session_start();
                 $_SESSION['userEmail'] = $userEmail;
                 $_SESSION['userNickName'] = $user_nickName;
                 $_SESSION['userAdmin'] = $user_admin;
                 
                 echo "로그인 성공!";
             }
             else {
                 echo "아이디 혹은 비밀번호가 틀립니다.";
             }
             
         }
         catch(PDOException $ex)
         {
             echo "<script>alert('로그인 실패.<br> 에러: ".$ex->getMessage()."')</script>";
         }
     }
     
     
     // 회원 가입
     public function signUp($movie_title, $movie_story, $movie_image, $movie_date, $movie_director, $movie_genre) {
     
         try {
             $sql = "INSERT INTO tMovieList(sMovieTitle, sMovieStory, sMovieImage, dtOpeningDate, sMovieDirector, sGenreID)
             VALUES('$movie_title', '$movie_story', '$movie_image'
             , '$movie_date', '$movie_director', '$movie_genre')";
             
             $this->connect->exec($sql);
             echo "<script>alert('영화가 성공적으로 등록되었습니다.');";
             echo "location.href='../../index.php';</script>";
         }
         catch(PDOException $ex) {
             echo "<script>alert('영화 등록에 실패했습니다.<br> 에러: ".$ex->getMessage()."')</script>";
         }
         
         echo "<script>location.href='../../index.php'</script>";
     
     }
     
     // 회원 삭제
     public function userDelete(){
         
     }
     
     
     // 회원 정보
     public function userSearch() {

         
        
     }
     
     // 회원정보 수정
     public function userUpdate() {
         
         
         
     }
    
}